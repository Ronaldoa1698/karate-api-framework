name: Karate API Tests

on:
  workflow_dispatch:
    inputs:
      test_tag:
        description: 'Tag del escenario a ejecutar (ej: @smoke) â€” opcional'
        required: false
        default: ''
        type: string
      test_name:
        description: 'Nombre exacto del escenario a ejecutar (opcional)'
        required: false
        default: ''
        type: string
      karate_options:
        description: 'Opciones arbitrarias para Karate (opcional). Ej: --tags @mytag -n "Scenario name"'
        required: false
        default: ''
        type: string
jobs:
  karate-tests:
    runs-on: Ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    - name: Run Karate Tests
      run: |
        set -e
        # construir KARATE_OPTS a partir de los inputs (permite combinarlos libremente)
        KARATE_OPTS="${{ github.event.inputs.karate_options }}"

        if [ -n "${{ github.event.inputs.test_tag }}" ]; then
          KARATE_OPTS="--tags ${{ github.event.inputs.test_tag }} $KARATE_OPTS"
        fi

        if [ -n "${{ github.event.inputs.test_name }}" ]; then
          # -n se usa para filtrar por nombre de escenario en Karate
          KARATE_OPTS="$KARATE_OPTS -n \"${{ github.event.inputs.test_name }}\""
        fi

        echo "Ejecutando mvn test -Dkarate.options=\"$KARATE_OPTS\""
        mvn test -Dkarate.options="$KARATE_OPTS"
    - name: Upload Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: karate-reports
        path: target/karate-reports/
